name: Add HTTPS Binding

on:
  workflow_dispatch:
    inputs:
      site_name:
        description: 'IIS Site Name'
        required: true
        type: string
      host_header:
        description: 'Host header (domain)'
        required: true
        type: string

jobs:
  bind:
    runs-on: [self-hosted, windows, iis]
    steps:
      - name: Add HTTPS binding
        shell: powershell
        run: |
          Import-Module WebAdministration
          $siteName = "${{ inputs.site_name }}"
          $hostHeader = "${{ inputs.host_header }}"

          # List all certs for debugging
          Write-Host "=== Certificates in LocalMachine\My ===" -ForegroundColor Cyan
          Get-ChildItem Cert:\LocalMachine\My | ForEach-Object {
            $san = ($_.Extensions | Where-Object { $_.Oid.FriendlyName -eq "Subject Alternative Name" } | ForEach-Object { $_.Format($false) })
            Write-Host "  Subject: $($_.Subject)" -ForegroundColor Gray
            Write-Host "  SAN: $san" -ForegroundColor Gray
            Write-Host "  Expires: $($_.NotAfter)" -ForegroundColor Gray
            Write-Host "  Thumbprint: $($_.Thumbprint)" -ForegroundColor Gray
            Write-Host ""
          }

          # Try to find cert - look for synthia.bot in subject or SAN
          $cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {
            $subj = $_.Subject
            $san = ($_.Extensions | Where-Object { $_.Oid.FriendlyName -eq "Subject Alternative Name" } | ForEach-Object { $_.Format($false) })
            $subj -like "*synthia*" -or $san -like "*synthia*"
          } | Sort-Object NotAfter -Descending | Select-Object -First 1

          # If no synthia cert, try wildcard certs
          if (-not $cert) {
            $cert = Get-ChildItem Cert:\LocalMachine\My | Where-Object {
              $_.Subject -like "CN=*.*" -or $_.Subject -like "*wildcard*"
            } | Sort-Object NotAfter -Descending | Select-Object -First 1
          }

          if (-not $cert) {
            Write-Host "No matching certificate found. See list above." -ForegroundColor Red
            Write-Host "You may need to specify the thumbprint manually." -ForegroundColor Yellow
            exit 1
          }

          Write-Host "Using cert: $($cert.Subject) [$($cert.Thumbprint)]" -ForegroundColor Green

          # Check if HTTPS binding already exists
          $existing = Get-WebBinding -Name $siteName -Protocol https -ErrorAction SilentlyContinue
          if ($existing) {
            Write-Host "HTTPS binding already exists for $siteName" -ForegroundColor Yellow
          } else {
            New-WebBinding -Name $siteName -Protocol https -Port 443 -HostHeader $hostHeader -SslFlags 1
            $binding = Get-WebBinding -Name $siteName -Protocol https
            $binding.AddSslCertificate($cert.Thumbprint, "My")
            Write-Host "HTTPS binding added: https://$hostHeader (SNI)" -ForegroundColor Green
          }
