name: Provision IIS Site

on:
  workflow_dispatch:
    inputs:
      project_id:
        description: 'Project ID (numeric, e.g., 2)'
        required: true
        type: string
      project_title:
        description: 'Project title in PascalCase (e.g., ApolloSpark)'
        required: true
        type: string
      domain:
        description: 'Public domain (e.g., apollospark.synthia.bot)'
        required: true
        type: string

jobs:
  provision:
    name: Provision IIS + Database
    runs-on: self-hosted
    env:
      CONVENTION_NAME: Demo_${{ inputs.project_id }}_${{ inputs.project_title }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run provisioning script
        shell: powershell
        run: |
          .\Deployment\provision-iis.ps1 `
            -ProjectId ${{ inputs.project_id }} `
            -ProjectTitle "${{ inputs.project_title }}" `
            -Domain "${{ inputs.domain }}"

      - name: Build and deploy backend
        shell: powershell
        run: |
          $siteName = "${{ env.CONVENTION_NAME }}"
          $backendPath = "F:\New_WWW\$siteName\API"

          Write-Host ">> Building backend..." -ForegroundColor Yellow
          dotnet publish backend\ProjectTemplate.Api\ProjectTemplate.Api.csproj `
            --configuration Release `
            --output .\publish\backend

          Write-Host ">> Deploying backend to $backendPath ..." -ForegroundColor Yellow
          $preserveFiles = @("appsettings.Production.json")
          $tempDir = Join-Path $env:TEMP "provision-preserve-$(Get-Random)"
          New-Item -ItemType Directory -Path $tempDir -Force | Out-Null

          foreach ($file in $preserveFiles) {
            $src = Join-Path $backendPath $file
            if (Test-Path $src) {
              Copy-Item $src (Join-Path $tempDir $file)
            }
          }

          Copy-Item -Path ".\publish\backend\*" -Destination $backendPath -Recurse -Force

          foreach ($file in $preserveFiles) {
            $src = Join-Path $tempDir $file
            if (Test-Path $src) {
              Copy-Item $src (Join-Path $backendPath $file) -Force
            }
          }

          Remove-Item $tempDir -Recurse -Force -ErrorAction SilentlyContinue
          Write-Host "   Backend deployed" -ForegroundColor Green

      - name: Build and deploy frontend
        shell: powershell
        run: |
          $siteName = "${{ env.CONVENTION_NAME }}"
          $frontendPath = "F:\New_WWW\$siteName\WWW"

          Write-Host ">> Building frontend..." -ForegroundColor Yellow
          Push-Location frontend
          npm ci
          npm run build
          Pop-Location

          Write-Host ">> Deploying frontend to $frontendPath ..." -ForegroundColor Yellow
          Copy-Item -Path "frontend\dist\*" -Destination $frontendPath -Recurse -Force
          Write-Host "   Frontend deployed" -ForegroundColor Green

      - name: Restart App Pool
        shell: powershell
        run: |
          Import-Module WebAdministration
          $appPool = "${{ env.CONVENTION_NAME }}"
          Write-Host ">> Restarting app pool: $appPool" -ForegroundColor Yellow
          if ((Get-WebAppPoolState -Name $appPool).Value -eq "Started") {
            Restart-WebAppPool -Name $appPool
          } else {
            Start-WebAppPool -Name $appPool
          }
          Write-Host "   App pool restarted" -ForegroundColor Green

      - name: Health check
        shell: powershell
        run: |
          $domain = "${{ inputs.domain }}"
          Write-Host ">> Waiting for site to start..." -ForegroundColor Yellow
          Start-Sleep -Seconds 8

          $maxRetries = 5
          $retryDelay = 5
          $healthy = $false

          for ($i = 1; $i -le $maxRetries; $i++) {
            try {
              $response = Invoke-WebRequest -Uri "http://localhost/api/health" `
                -Headers @{ Host = $domain } `
                -UseBasicParsing -TimeoutSec 15
              if ($response.StatusCode -eq 200) {
                Write-Host "   Health check passed! (attempt $i)" -ForegroundColor Green
                Write-Host "   Response: $($response.Content)" -ForegroundColor Gray
                $healthy = $true
                break
              }
            } catch {
              Write-Host "   Attempt $i/$maxRetries failed: $_" -ForegroundColor Yellow
              if ($i -lt $maxRetries) {
                Start-Sleep -Seconds $retryDelay
              }
            }
          }

          if (!$healthy) {
            Write-Host "   Health check did not pass after $maxRetries attempts (non-fatal)" -ForegroundColor Yellow
          }

      - name: Output summary
        shell: powershell
        run: |
          $conventionName = "${{ env.CONVENTION_NAME }}"
          $domain = "${{ inputs.domain }}"
          $projectTitle = "${{ inputs.project_title }}"

          Write-Host ""
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host " PROVISIONING COMPLETE" -ForegroundColor Green
          Write-Host "==========================================================" -ForegroundColor Cyan
          Write-Host ""
          Write-Host " Convention: $conventionName"
          Write-Host " Project:    $projectTitle"
          Write-Host " Domain:     $domain"
          Write-Host " IIS Site:   $conventionName"
          Write-Host " App Pool:   $conventionName"
          Write-Host " Database:   $conventionName"
          Write-Host " Frontend:   F:\New_WWW\$conventionName\WWW"
          Write-Host " Backend:    F:\New_WWW\$conventionName\API"
          Write-Host ""
          Write-Host " URLs:"
          Write-Host "   https://$domain"
          Write-Host "   https://$domain/api/health"
          Write-Host ""
          Write-Host " Next steps:"
          Write-Host "   1. Set IIS_SITE_NAME repo variable to: $conventionName"
          Write-Host "   2. Use Deploy workflow for future deployments"
          Write-Host "==========================================================" -ForegroundColor Cyan

          $summaryContent = @"
          ## Provisioning Complete

          | Property | Value |
          |----------|-------|
          | **Convention** | $conventionName |
          | **Domain** | $domain |
          | **IIS Site** | $conventionName |
          | **App Pool** | $conventionName |
          | **Database** | $conventionName |

          ### Next Steps
          1. Set ``IIS_SITE_NAME`` repo variable to ``$conventionName``
          2. Use **Deploy** workflow for future deployments
          "@

          $summaryContent | Out-File -FilePath $env:GITHUB_STEP_SUMMARY -Encoding UTF8 -Append
